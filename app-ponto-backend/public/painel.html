<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel RH - BMZ Advogados</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', 'Segoe UI', sans-serif;
    background-color: #f4f4f8;
    color: #2e3a59;
    min-height: 100vh;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
}

.header {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px 30px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}

.header h1 {
    font-size: 1.75rem;
    color: #0052cc;
    font-weight: 600;
}

.header .info {
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 0.9rem;
    color: #6b7280;
}

.status-badge {
    background-color: #28a745;
    color: white;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
}

.tabs {
    display: flex;
    background: #ffffff;
    border-radius: 8px;
    padding: 6px;
    margin-bottom: 24px;
    border: 1px solid #e5e7eb;
    overflow-x: auto;
}

.tab {
    flex: 1;
    text-align: center;
    padding: 12px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.95rem;
    color: #6b7280;
    cursor: pointer;
    transition: background 0.2s ease;
    white-space: nowrap;
}

.tab.active {
    background-color: #0052cc;
    color: #ffffff;
    font-weight: 600;
}

.tab:hover:not(.active) {
    background-color: #f0f4f8;
    color: #0052cc;
}

.content-panel {
    display: none;
}

.content-panel.active {
    display: block;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #ffffff;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #0052cc;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2e3a59;
}

.stat-label {
    font-size: 0.85rem;
    color: #6b7280;
}

.panel-card {
    background: #ffffff;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    overflow: hidden;
}

.panel-header {
    background: #0052cc;
    color: white;
    padding: 16px 24px;
    font-size: 1.1rem;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.refresh-btn {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: background 0.2s ease;
}

.refresh-btn:hover {
    background-color: rgba(255, 255, 255, 0.3);
}

.table-container {
    max-height: 600px;
    overflow-y: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.9rem;
    text-align: left;
}

th {
    background-color: #f9fafb;
    color: #2e3a59;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}

tr:hover {
    background-color: #f4f6f8;
}

.status-badge-small {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pendente {
    background: #fff8e1;
    color: #ff9800;
}

.status-aprovado {
    background: #e6f4ea;
    color: #2e7d32;
}

.status-rejeitado {
    background: #fdecea;
    color: #d32f2f;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 500;
    transition: background 0.2s ease;
}

.btn-approve {
    background: #28a745;
    color: white;
}

.btn-approve:hover {
    background: #218838;
}

.btn-reject {
    background: #dc3545;
    color: white;
}

.btn-reject:hover {
    background: #c82333;
}

.btn-view {
    background: #17a2b8;
    color: white;
}

.btn-view:hover {
    background: #138496;
}

.filters {
    padding: 20px 30px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-label {
    font-size: 0.85rem;
    color: #6b7280;
    font-weight: 600;
}

.filter-input {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.9rem;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}

.loading i {
    font-size: 2rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 500px;
    margin: 50px auto;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    background: #0052cc;
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.modal-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    color: #374151;
}

.form-input, .form-textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.95rem;
    background: #ffffff;
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.btn-modal {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-primary {
    background: #0052cc;
    color: white;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.user-select {
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.95rem;
    width: 200px;
    background: #fff;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
}

.empty-state i {
    font-size: 3.5rem;
    opacity: 0.2;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .container {
        padding: 12px;
    }

    .header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .filters {
        flex-direction: column;
        align-items: stretch;
    }
}

    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1><i class="fas fa-chart-line"></i> Painel RH - BMZ</h1>
                <p style="color: #666; margin-top: 5px;">Sistema de Controle de Ponto Eletrônico</p>
            </div>
            <div class="info">
                <div class="status-badge">
                    <i class="fas fa-wifi"></i> Online
                </div>
                <span style="color: #666;">Atualizado em: <span id="lastUpdate">--:--</span></span>
            </div>
        </div>

        <!-- Estatísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="color: #28a745;">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number" id="totalUsuarios">--</div>
                <div class="stat-label">Usuários Ativos</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: #ffc107;">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-number" id="ajustesPendentes">--</div>
                <div class="stat-label">Ajustes Pendentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: #17a2b8;">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-number" id="pontosHoje">--</div>
                <div class="stat-label">Pontos Hoje</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: #dc3545;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-number" id="problemas">--</div>
                <div class="stat-label">Inconsistências</div>
            </div>
        </div>

        <!-- Abas -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('ajustes')">
                <i class="fas fa-edit"></i> Solicitações de Ajuste
            </div>
            <div class="tab" onclick="showTab('pontos')">
                <i class="fas fa-history"></i> Histórico de Pontos
            </div>
            <div class="tab" onclick="showTab('usuarios')">
                <i class="fas fa-users"></i> Usuários
            </div>
            <div class="tab" onclick="showTab('relatorios')">
                <i class="fas fa-chart-bar"></i> Relatórios
            </div>
        </div>

        <!-- Painel de Ajustes -->
        <div id="ajustes" class="content-panel active">
            <div class="panel-card">
                <div class="panel-header">
                    <h2 class="panel-title">Solicitações de Ajuste de Horário</h2>
                    <button class="refresh-btn" onclick="carregarAjustes()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Status:</label>
                        <select class="filter-input" id="filtroStatus" onchange="filtrarAjustes()">
                            <option value="">Todos</option>
                            <option value="pendente">Pendentes</option>
                            <option value="aprovado">Aprovados</option>
                            <option value="rejeitado">Rejeitados</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Usuário:</label>
                        <input type="text" class="filter-input" id="filtroUsuario" placeholder="Nome ou CPF" onkeyup="filtrarAjustes()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Data:</label>
                        <input type="date" class="filter-input" id="filtroData" onchange="filtrarAjustes()">
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Usuário</th>
                                <th>Ponto Original</th>
                                <th>Novo Horário</th>
                                <th>Motivo</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="ajustesTableBody">
                            <tr>
                                <td colspan="7" class="loading">
                                    <i class="fas fa-spinner"></i><br>
                                    Carregando solicitações...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Painel de Pontos -->
        <div id="pontos" class="content-panel">
            <div class="panel-card">
                <div class="panel-header">
                    <h2 class="panel-title">Histórico de Pontos</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select class="user-select" id="usuarioSelect" onchange="carregarPontos()">
                            <option value="">Todos os usuários</option>
                        </select>
                        <button class="refresh-btn" onclick="carregarPontos()">
                            <i class="fas fa-sync-alt"></i> Atualizar
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Usuário</th>
                                <th>Tipo</th>
                                <th>Horário</th>
                                <th>Localização</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="pontosTableBody">
                            <tr>
                                <td colspan="6" class="loading">
                                    <i class="fas fa-spinner"></i><br>
                                    Carregando pontos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Painel de Usuários -->
        <div id="usuarios" class="content-panel">
            <div class="panel-card">
                <div class="panel-header">
                    <h2 class="panel-title">Usuários Cadastrados</h2>
                    <button class="refresh-btn" onclick="carregarUsuarios()">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>CPF</th>
                                <th>Empresa</th>
                                <th>Último Login</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="usuariosTableBody">
                            <tr>
                                <td colspan="6" class="loading">
                                    <i class="fas fa-spinner"></i><br>
                                    Carregando usuários...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Painel de Relatórios -->
        <div id="relatorios" class="content-panel">
            <div class="panel-card">
                <div class="panel-header">
                    <h2 class="panel-title">Relatórios</h2>
                    <button class="refresh-btn" onclick="gerarRelatorio()">
                        <i class="fas fa-download"></i> Gerar
                    </button>
                </div>
                <div style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h3><i class="fas fa-file-excel"></i> Relatório Mensal</h3>
                            <p style="margin: 10px 0; color: #666;">Pontos de todos os usuários no mês atual</p>
                            <button class="btn btn-view" onclick="exportarRelatorio('mensal')">Baixar Excel</button>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h3><i class="fas fa-file-pdf"></i> Relatório de Ajustes</h3>
                            <p style="margin: 10px 0; color: #666;">Todas as solicitações de ajuste</p>
                            <button class="btn btn-view" onclick="exportarRelatorio('ajustes')">Baixar PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ação -->
    <div id="modalAcao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitulo">Processar Solicitação</h3>
                <button class="modal-close" onclick="fecharModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalDetalhes"></div>
                <div class="form-group">
                    <label class="form-label">Mensagem para o funcionário (opcional):</label>
                    <textarea class="form-textarea" id="respostaMensagem" placeholder="Digite uma mensagem explicativa..."></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn-modal btn-secondary" onclick="fecharModal()">Cancelar</button>
                    <button class="btn-modal btn-primary" id="btnConfirmar" onclick="confirmarAcao()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ajustesData = [];
        let pontosData = [];
        let usuariosData = [];
        let acao = '';
        let ajusteId = '';

        // Função para mostrar abas
        function showTab(tabName) {
            // Ocultar todas as abas
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Carregar dados da aba
            switch(tabName) {
                case 'ajustes':
                    carregarAjustes();
                    break;
                case 'pontos':
                    carregarPontos();
                    break;
                case 'usuarios':
                    carregarUsuarios();
                    break;
            }
        }

        // Carregar ajustes
        async function carregarAjustes() {
            try {
                const response = await fetch('/api/ajustes/admin');
                const data = await response.json();
                
                if (data.success) {
                    ajustesData = data.ajustes;
                    renderizarAjustes(ajustesData);
                    atualizarEstatisticas();
                } else {
                    console.error('Erro ao carregar ajustes:', data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('ajustesTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Erro ao carregar dados
                        </td>
                    </tr>
                `;
            }
        }

        // Renderizar tabela de ajustes
        function renderizarAjustes(ajustes) {
            const tbody = document.getElementById('ajustesTableBody');
            
            if (ajustes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-inbox"></i><br>
                            Nenhuma solicitação encontrada
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = ajustes.map(ajuste => `
                <tr>
                    <td>${new Date(ajuste.criadoEm).toLocaleString('pt-BR')}</td>
                    <td>${ajuste.usuario?.nome || ajuste.cpf}</td>
                    <td>${new Date(ajuste.pontoOriginal?.dataHora).toLocaleString('pt-BR')}</td>
                    <td>${new Date(ajuste.novoHorario).toLocaleString('pt-BR')}</td>
                    <td title="${ajuste.motivo}">${ajuste.motivo.substring(0, 50)}${ajuste.motivo.length > 50 ? '...' : ''}</td>
                    <td><span class="status-badge-small status-${ajuste.status}">${ajuste.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${ajuste.status === 'pendente' ? `
                                <button class="btn btn-approve" onclick="abrirModal('${ajuste._id}', 'aprovar')" title="Aprovar">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-reject" onclick="abrirModal('${ajuste._id}', 'rejeitar')" title="Rejeitar">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-view" onclick="verDetalhes('${ajuste._id}')" title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Filtrar ajustes
        function filtrarAjustes() {
            const status = document.getElementById('filtroStatus').value;
            const usuario = document.getElementById('filtroUsuario').value.toLowerCase();
            const data = document.getElementById('filtroData').value;

            let ajustesFiltrados = ajustesData.filter(ajuste => {
                const matchStatus = !status || ajuste.status === status;
                const matchUsuario = !usuario || 
                    (ajuste.usuario?.nome || '').toLowerCase().includes(usuario) ||
                    ajuste.cpf.includes(usuario);
                const matchData = !data || 
                    new Date(ajuste.criadoEm).toDateString() === new Date(data).toDateString();

                return matchStatus && matchUsuario && matchData;
            });

            renderizarAjustes(ajustesFiltrados);
        }

        // Abrir modal
        function abrirModal(id, tipoAcao) {
            ajusteId = id;
            acao = tipoAcao;
            
            const ajuste = ajustesData.find(a => a._id === id);
            if (!ajuste) return;

            document.getElementById('modalTitulo').textContent = 
                tipoAcao === 'aprovar' ? 'Aprovar Solicitação' : 'Rejeitar Solicitação';
            
            document.getElementById('modalDetalhes').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>Usuário:</strong> ${ajuste.usuario?.nome || ajuste.cpf}<br>
                    <strong>Motivo:</strong> ${ajuste.motivo}<br>
                    <strong>Horário atual:</strong> ${new Date(ajuste.pontoOriginal?.dataHora).toLocaleString('pt-BR')}<br>
                    <strong>Novo horário:</strong> ${new Date(ajuste.novoHorario).toLocaleString('pt-BR')}
                </div>
            `;

            document.getElementById('btnConfirmar').textContent = 
                tipoAcao === 'aprovar' ? 'Aprovar' : 'Rejeitar';
            document.getElementById('btnConfirmar').className = 
                `btn-modal ${tipoAcao === 'aprovar' ? 'btn-primary' : 'btn-reject'}`;

            document.getElementById('modalAcao').style.display = 'block';
        }

        // Confirmar ação
        async function confirmarAcao() {
            const mensagem = document.getElementById('respostaMensagem').value;
            const status = acao === 'aprovar' ? 'aprovado' : 'rejeitado';

            try {
                const response = await fetch(`/api/ajustes/${ajusteId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: status,
                        respostaMensagem: mensagem
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(`Solicitação ${status} com sucesso!`);
                    fecharModal();
                    carregarAjustes();
                } else {
                    alert('Erro: ' + data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao processar solicitação');
            }
        }

        // Fechar modal
        function fecharModal() {
            document.getElementById('modalAcao').style.display = 'none';
            document.getElementById('respostaMensagem').value = '';
        }

        // Ver detalhes
        function verDetalhes(id) {
            const ajuste = ajustesData.find(a => a._id === id);
            if (!ajuste) return;

            alert(`
Detalhes da Solicitação:

Usuário: ${ajuste.usuario?.nome || ajuste.cpf}
Data da solicitação: ${new Date(ajuste.criadoEm).toLocaleString('pt-BR')}
Motivo: ${ajuste.motivo}
Status: ${ajuste.status}
${ajuste.respostaMensagem ? `Resposta: ${ajuste.respostaMensagem}` : ''}
            `);
        }

        // Carregar pontos
        async function carregarPontos() {
            try {
                const usuarioId = document.getElementById('usuarioSelect').value;
                const url = usuarioId ? `/api/pontos/admin?usuario=${usuarioId}` : '/api/pontos/admin';
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    pontosData = data.pontos;
                    renderizarPontos(pontosData);
                } else {
                    console.error('Erro ao carregar pontos:', data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('pontosTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Erro ao carregar dados
                        </td>
                    </tr>
                `;
            }
        }

        // Renderizar pontos
        function renderizarPontos(pontos) {
            const tbody = document.getElementById('pontosTableBody');
            
            if (pontos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-inbox"></i><br>
                            Nenhum ponto encontrado
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pontos.map(ponto => `
                <tr>
                    <td>${new Date(ponto.dataHora).toLocaleDateString('pt-BR')}</td>
                    <td>${ponto.usuario?.nome || 'N/A'}</td>
                    <td>${formatarTipoPonto(ponto.tipo)}</td>
                    <td>${new Date(ponto.dataHora).toLocaleTimeString('pt-BR')}</td>
                    <td>${ponto.localizacao?.endereco || 'N/A'}</td>
                    <td><span class="status-badge-small status-${ponto.fotoVerificada ? 'aprovado' : 'pendente'}">${ponto.fotoVerificada ? 'Verificado' : 'Pendente'}</span></td>
                </tr>
            `).join('');
        }

        // Carregar usuários
        async function carregarUsuarios() {
            try {
                const response = await fetch('/api/auth/admin/usuarios');
                const data = await response.json();
                
                if (data.success) {
                    usuariosData = data.usuarios;
                    renderizarUsuarios(usuariosData);
                    popularSelectUsuarios(usuariosData);
                } else {
                    console.error('Erro ao carregar usuários:', data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('usuariosTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Erro ao carregar dados
                        </td>
                    </tr>
                `;
            }
        }

        // Renderizar usuários
        function renderizarUsuarios(usuarios) {
            const tbody = document.getElementById('usuariosTableBody');
            
            if (usuarios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-inbox"></i><br>
                            Nenhum usuário encontrado
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = usuarios.map(usuario => `
                <tr>
                    <td>${usuario.nome} ${usuario.sobrenome || ''}</td>
                    <td>${usuario.email}</td>
                    <td>${formatarCPF(usuario.cpf)}</td>
                    <td>${usuario.empresa || 'BMZ Advogados'}</td>
                    <td>${usuario.ultimoLogin ? new Date(usuario.ultimoLogin).toLocaleString('pt-BR') : 'Nunca'}</td>
                    <td><span class="status-badge-small status-aprovado">Ativo</span></td>
                </tr>
            `).join('');
        }

        // Popular select de usuários
        function popularSelectUsuarios(usuarios) {
            const select = document.getElementById('usuarioSelect');
            select.innerHTML = '<option value="">Todos os usuários</option>';
            usuarios.forEach(usuario => {
                select.innerHTML += `<option value="${usuario._id}">${usuario.nome} ${usuario.sobrenome || ''}</option>`;
            });
        }

        // Atualizar estatísticas
        function atualizarEstatisticas() {
            document.getElementById('totalUsuarios').textContent = usuariosData.length;
            document.getElementById('ajustesPendentes').textContent = ajustesData.filter(a => a.status === 'pendente').length;
            document.getElementById('pontosHoje').textContent = pontosData.filter(p => 
                new Date(p.dataHora).toDateString() === new Date().toDateString()
            ).length;
            document.getElementById('problemas').textContent = '0'; // Implementar lógica de problemas
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('pt-BR');
        }

        // Funções utilitárias
        function formatarTipoPonto(tipo) {
            const tipos = {
                'entrada': 'Entrada',
                'saida_almoco': 'Saída Almoço',
                'entrada_almoco': 'Retorno Almoço',
                'saida': 'Saída'
            };
            return tipos[tipo] || tipo;
        }

        function formatarCPF(cpf) {
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        // Exportar relatórios
        function exportarRelatorio(tipo) {
            alert(`Funcionalidade de exportação ${tipo} será implementada em breve!`);
        }

        // Gerar relatório
        function gerarRelatorio() {
            alert('Gerando relatórios...');
        }

        // Eventos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModal();
            }
        });

        // Fechar modal clicando fora
        document.getElementById('modalAcao').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModal();
            }
        });

        // Auto-refresh a cada 30 segundos
        setInterval(() => {
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabText = activeTab.textContent.trim();
                if (tabText.includes('Ajuste')) {
                    carregarAjustes();
                } else if (tabText.includes('Pontos')) {
                    carregarPontos();
                } else if (tabText.includes('Usuários')) {
                    carregarUsuarios();
                }
            }
        }, 30000);

        // Inicializar painel
        document.addEventListener('DOMContentLoaded', function() {
            carregarAjustes();
            carregarUsuarios();
            atualizarEstatisticas();
        });
    </script>
</body>
</html>